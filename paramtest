from github_manager.github_manager import GitHubManager
from github_manager.repo_manager import RepoManager
from authentication import Authentication


class GitHubManagerImpl(GitHubManager):
    def __init__(self, parameters):
        self.__parameters = parameters
        self.__auth = Authentication(self.__parameters)
        self.__repo_manager = RepoManager()

    def create_repository(self) -> str:
        """
        Implements the abstract method to create a GitHub repository.
        Prepares data and calls RepoManager for API interaction.

        :return: URL of the created repository.
        """
        # Collect parameters
        repo_name = self.__parameters.get_param("repo_name")
        repo_description = self.__parameters.get_param("repo_description")
        organization_name = self.__parameters.get_param("organization_name")
        api_url = "https://api.github.com"

        # Validate repository name
        if not repo_name:
            raise ValueError("Repository name is required.")

        # Construct the API endpoint URL
        if organization_name:
            url = f"{api_url}/orgs/{organization_name}/repos"
        else:
            url = f"{api_url}/user/repos"

        # Get authentication headers
        headers = self.__auth.get_headers()

        # Prepare data payload
        data = {
            "name": repo_name,
            "description": repo_description,
            "private": False,
        }

        # Call RepoManager to create the repository
        return self.__repo_manager.create_repository(url, headers, data)

    def run(self):
        """
        Implements the abstract method to handle the main workflow.
        """
        try:
            # Create repository
            repo_url = self.create_repository()
            print(f"Repository created successfully: {repo_url}")
        except Exception as e:
            print(f"Error: {e}")



import requests


class RepoManager:
    def __init__(self):
        pass

    def create_repository(self, url: str, headers: dict, data: dict) -> str:
        """
        Sends the request to create a GitHub repository.
        :param url: API endpoint URL.
        :param headers: Authentication headers.
        :param data: Repository details as payload.
        :return: URL of the created repository.
        """
        response = requests.post(url, json=data, headers=headers)
        if response.status_code == 201:
            return response.json()["html_url"]
        else:
            raise Exception(f"Failed to create repository: {response.status_code}, {response.text}")


import unittest
from unittest.mock import Mock, patch
from github_manager.github_manager_impl import GitHubManagerImpl
from github_manager.repo_manager import RepoManager
from github_manager.authentication import Authentication
from parameters.params_impl import Parameters


class TestGitHubManagerImpl(unittest.TestCase):
    def setUp(self):
        # Mock parameters
        self.parameters = Mock()
        self.parameters.get_param.side_effect = lambda key: {
            "repo_name": "test-repo",
            "repo_description": "Test description",
            "organization_name": "test-org",
            "github_token": "fake-token",
        }.get(key)

        # Mock RepoManager
        self.repo_manager = Mock()
        self.repo_manager.create_repository.return_value = "https://github.com/test-org/test-repo"

        # Mock Authentication
        self.auth = Mock()
        self.auth.get_headers.return_value = {"Authorization": "token fake-token"}

        # Patch RepoManager and Authentication in GitHubManagerImpl
        with patch('github_manager.github_manager_impl.RepoManager', return_value=self.repo_manager), \
             patch('github_manager.github_manager_impl.Authentication', return_value=self.auth):
            self.github_manager = GitHubManagerImpl(self.parameters)

    def test_create_repository(self):
        result = self.github_manager.create_repository()
        self.assertEqual(result, "https://github.com/test-org/test-repo")

    def test_run_success(self):
        with patch('builtins.print') as mock_print:
            self.github_manager.run()
            mock_print.assert_called_with("Repository created successfully: https://github.com/test-org/test-repo")

    def test_run_failure(self):
        self.repo_manager.create_repository.side_effect = Exception("API error")
        with patch('builtins.print') as mock_print:
            self.github_manager.run()
            mock_print.assert_called_with("Error: API error")


if __name__ == "__main__":
    unittest.main()
